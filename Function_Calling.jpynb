{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Function Calling\n",
    "\n",
    "<img src=\"Images/ima.png\" width=\"800\" height=\"400\">"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Library"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 78,
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import json\n",
    "import requests\n",
    "from dotenv import load_dotenv\n",
    "from openai import  AzureOpenAI"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Load .ENV"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "None\n"
     ]
    }
   ],
   "source": [
    "load_dotenv(dotenv_path='/Users/veronica/IA_2024/Modulo02_Sprint02/my-python-project/.venv/.env', override=True)\n",
    "az_openai_client=os.getenv(\"AZURE_OPENAI_API_KEY\")\n",
    "az_openai_endpoint = os.getenv(\"AZURE_OPENAI_ENDPOINT_URL\")\n",
    "az_openai_api_key = os.getenv(\"AZURE_OPENAI_API_KEY\")\n",
    "az_openai_deployment_name = os.getenv(\"AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT_NAME \")\n",
    "bing_api_key = os.getenv(\"BING_API_KEY\")\n",
    "\n",
    "print(az_openai_endpoint)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Crear Cliente Azure Open AI"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 103,
   "metadata": {},
   "outputs": [],
   "source": [
    "#\n",
    "az_openai_client = AzureOpenAI(\n",
    "\tazure_endpoint= az_openai_endpoint,\n",
    "\tapi_key=az_openai_api_key,\n",
    "\tapi_version=\"2024-05-01-preview\",\n",
    ")\n",
    "message = []"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Functions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 116,
   "metadata": {},
   "outputs": [],
   "source": [
    "def store_message_in_list(message_list, message_role, **kwargs):\n",
    "\t# Create the base message with the required role\n",
    "\tmessage = {\"role\": message_role}\n",
    "\t# Dynamically add additional fields from kwargs\n",
    "\tmessage.update(kwargs)\n",
    "\t# Append the message to the list\n",
    "\tmessage_list.append(message)\n",
    "\n",
    "# Azure OpenAI API Calls\n",
    "def call_azure_openai(az_openai_client, az_openai_deployment_name, messages):\n",
    "\t# Build the parameters dynamically\n",
    "\tparams = {\n",
    "\t\t\"model\": az_openai_deployment_name,\n",
    "\t\t\"messages\": messages\n",
    "\t}\n",
    "\t# Call the Azure OpenAI API\n",
    "\tresponse = az_openai_client.chat.completions.create(**params)\n",
    "\treturn response\n",
    "\n",
    "def send_user_input_to_az_openai(user_input):\n",
    "    \"\"\"\n",
    "    Env√≠a la entrada del usuario al servicio Azure OpenAI y devuelve la respuesta.\n",
    "\n",
    "    :param user_input: Texto ingresado por el usuario (str)\n",
    "    :return: Respuesta del modelo (str)\n",
    "    \"\"\"\n",
    "    try:\n",
    "        # Crear cliente OpenAI con Azure\n",
    "        client = OpenAIClient(\n",
    "            endpoint=AZURE_OPENAI_ENDPOINT,\n",
    "            credential=AzureKeyCredential(AZURE_OPENAI_API_KEY)\n",
    "        )\n",
    "\n",
    "        # Configuraci√≥n de la solicitud\n",
    "        response = client.get_chat_completions(\n",
    "            model=MODEL_NAME,\n",
    "            messages=[\n",
    "                {\"role\": \"system\", \"content\": \"Eres un asistente √∫til.\"},  # Contexto inicial\n",
    "                {\"role\": \"user\", \"content\": user_input}  # Entrada del usuario\n",
    "            ],\n",
    "            temperature=0.7,  # Control de creatividad\n",
    "            max_tokens=200  # Longitud m√°xima de la respuesta\n",
    "        )\n",
    "\n",
    "        # Extraer la respuesta del modelo\n",
    "        model_reply = response.choices[0].message[\"content\"]\n",
    "        return model_reply\n",
    "\n",
    "    except Exception as e:\n",
    "        return f\"Error al comunicarse con Azure OpenAI: {str(e)}\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Inicializar Mensajes"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 106,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "prueba\n"
     ]
    }
   ],
   "source": [
    "SYSTEM_MESSAGE=\"Soy un bot de Azure OpenIA , Y me gustaria ayudarte en lo que necesites referente a la organizacion de vuelos\"\n",
    "store_message_in_list(message, \"system\", content=SYSTEM_MESSAGE)\n",
    "\n",
    "print (SYSTEM_MESSAGE)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Comprobar Fecha cut-off del modelo"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 123,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Respuesta del modelo: Error al comunicarse con Azure OpenAI: name 'OpenAIClient' is not defined\n"
     ]
    }
   ],
   "source": [
    "user_input = \"Hasta que fecha has aprendido?\"\n",
    "\n",
    "response = send_user_input_to_az_openai(user_input)\n",
    "\n",
    "print(\"Respuesta del modelo:\", response)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Busqueda en Bing"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 59,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OpenAI\n",
      "https://openai.com/\n",
      "Bring your imagination to life from text, image, or video. A new series of AI models designed to spend more time thinking before they respond. Chat about email, screenshots, files, and anything on your screen. Instant answers. Greater productivity. Endless inspiration.\n",
      "\n"
     ]
    }
   ],
   "source": [
    "import requests\n",
    "# Lista para almacenar los mensajes\n",
    "messages = []\n",
    "\n",
    "def store_message_in_list(role, content):\n",
    "    message = {\"role\": role, \"content\": content}\n",
    "    messages.append(message)\n",
    "def search_bing_for_data(query):\n",
    "    headers = {\n",
    "        'Ocp-Apim-Subscription-Key': bing_api_key\n",
    "    }\n",
    "    params = {\n",
    "        'q': query,\n",
    "        'count': 1\n",
    "    }\n",
    "    response = requests.get('https://api.bing.microsoft.com/v7.0/search', headers=headers, params=params)\n",
    "    response.raise_for_status()\n",
    "    return response.json()\n",
    "\n",
    "# Realizar una b√∫squeda de ejemplo\n",
    "query = \"inteligencia artificial\"\n",
    "results = search_bing_for_data(query)\n",
    "\n",
    "# Imprimir los resultados\n",
    "for result in results['webPages']['value']:\n",
    "    print(result['name'])\n",
    "    print(result['url'])\n",
    "    print(result['snippet'])\n",
    "    print()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'_type': 'SearchResponse',\n",
       " 'queryContext': {'originalQuery': 'Capital de Francia'},\n",
       " 'webPages': {'webSearchUrl': 'https://www.bing.com/search?q=Capital+de+Francia',\n",
       "  'totalEstimatedMatches': 12600000,\n",
       "  'value': [{'id': 'https://api.bing.microsoft.com/api/v7/#WebPages.0',\n",
       "    'name': 'Par√≠s - Wikipedia, la enciclopedia libre',\n",
       "    'url': 'https://es.wikipedia.org/wiki/Par%C3%ADs',\n",
       "    'thumbnailUrl': 'https://www.bing.com/th?id=OIP.ydQwflIykYmIBA4N_ymevgHaEo&w=80&h=80&c=1&pid=5.1',\n",
       "    'isFamilyFriendly': True,\n",
       "    'displayUrl': 'https://es.wikipedia.org/wiki/Par√≠s',\n",
       "    'snippet': 'Par√≠s es la capital de Francia y su ciudad m√°s poblada, con una rica historia y cultura. Conoce su origen, su geograf√≠a, su econom√≠a, sus monumentos y su vida social en este art√≠culo de Wikipedia.',\n",
       "    'dateLastCrawled': '2025-01-19T12:22:00.0000000Z',\n",
       "    'primaryImageOfPage': {'thumbnailUrl': 'https://www.bing.com/th?id=OIP.ydQwflIykYmIBA4N_ymevgHaEo&w=80&h=80&c=1&pid=5.1',\n",
       "     'width': 88,\n",
       "     'height': 88,\n",
       "     'sourceWidth': 474,\n",
       "     'sourceHeight': 296,\n",
       "     'imageId': 'OIP.ydQwflIykYmIBA4N_ymevgHaEo'},\n",
       "    'language': 'es',\n",
       "    'isNavigational': False,\n",
       "    'noCache': False,\n",
       "    'siteName': 'Wikipedia'}]},\n",
       " 'entities': {'value': [{'id': 'https://api.bing.microsoft.com/api/v7/#Entities.0',\n",
       "    'contractualRules': [{'_type': 'ContractualRules/LicenseAttribution',\n",
       "      'targetPropertyName': 'description',\n",
       "      'mustBeCloseToContent': True,\n",
       "      'license': {'name': 'CC-BY-SA',\n",
       "       'url': 'http://creativecommons.org/licenses/by-sa/3.0/'},\n",
       "      'licenseNotice': 'Text under CC-BY-SA license'},\n",
       "     {'_type': 'ContractualRules/LinkAttribution',\n",
       "      'targetPropertyName': 'description',\n",
       "      'mustBeCloseToContent': True,\n",
       "      'text': 'Wikipedia',\n",
       "      'url': 'https://de.wikipedia.org/wiki/Paris'},\n",
       "     {'_type': 'ContractualRules/MediaAttribution',\n",
       "      'targetPropertyName': 'image',\n",
       "      'mustBeCloseToContent': True,\n",
       "      'url': 'https://de.wikipedia.org/wiki/Paris'}],\n",
       "    'webSearchUrl': 'https://www.bing.com/entityexplore?q=Paris&filters=sid:%2285584d24-2116-5b98-89f9-5714db931ac6%22&elv=AXXfrEiqqD9r3GuelwApulp9Sgr1sP*YAzjHPmuIE38N9Ku2AiYcN2*VOw*BjuVnpdWNN99QgbYBQlFDSVI896HGD5px7R2kTrHLelvXW1iB',\n",
       "    'name': 'Paris',\n",
       "    'url': 'https://www.paris.fr/',\n",
       "    'image': {'name': 'Paris',\n",
       "     'thumbnailUrl': 'http://www.bing.com/th?id=OSK.7ea92a29ea918ee16f3968fb388818b2&w=110&h=110&c=7',\n",
       "     'provider': [{'_type': 'Organization',\n",
       "       'url': 'https://de.wikipedia.org/wiki/Paris'}],\n",
       "     'hostPageUrl': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Grandes_Armes_de_Paris.svg/115px-Grandes_Armes_de_Paris.svg.png',\n",
       "     'width': 110,\n",
       "     'height': 110,\n",
       "     'sourceWidth': 115,\n",
       "     'sourceHeight': 137},\n",
       "    'description': 'Paris ist die Hauptstadt der Franz√∂sischen Republik, Hauptort der Region √éle-de-France und Globalstadt. Mit rund 2,11 Millionen Einwohnern ist Paris die viertgr√∂√üte Stadt der Europ√§ischen Union. Der Gro√üraum ist mit √ºber 12,5 Millionen Menschen die gr√∂√üte Metropolregion der EU.',\n",
       "    'entityPresentationInfo': {'entityScenario': 'DominantEntity',\n",
       "     'entityTypeHints': ['City', 'Place']},\n",
       "    'bingId': '85584d24-2116-5b98-89f9-5714db931ac6'}]},\n",
       " 'images': {'id': 'https://api.bing.microsoft.com/api/v7/#Images',\n",
       "  'readLink': 'https://api.bing.microsoft.com/api/v7/images/search?q=capital+de+francia&qpvt=Capital+de+Francia',\n",
       "  'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&qpvt=Capital+de+Francia',\n",
       "  'isFamilyFriendly': True,\n",
       "  'value': [{'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=8156164473EB51085570BD7F35C979665711B792&FORM=IQFRBA',\n",
       "    'name': 'Paris, Ile-de-France, France - The Eiffel Tower - the main landmark of ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.6cDuxunoN6cCKMYAk4hnXQHaFc&pid=Api',\n",
       "    'datePublished': '2022-06-03T11:10:00.0000000Z',\n",
       "    'contentUrl': 'https://c8.alamy.com/comp/PYHHJ6/paris-ile-de-france-france-the-eiffel-tower-the-main-landmark-of-the-french-capital-PYHHJ6.jpg',\n",
       "    'hostPageUrl': 'https://www.alamy.com/paris-ile-de-france-france-the-eiffel-tower-the-main-landmark-of-the-french-capital-image223507150.html',\n",
       "    'contentSize': '186146 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.alamy.com/paris-ile-de-france-france-the-eiffel-tower-the-main-landmark-of-the-french-capital-image223507150.html',\n",
       "    'width': 1300,\n",
       "    'height': 956,\n",
       "    'thumbnail': {'width': 474, 'height': 348}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=979A0CAD00A4F8C0DA80CFF30AF590EDC0ED1048&FORM=IQFRBA',\n",
       "    'name': 'Paris 2020 - Capital de Francia y principal ciudad de Europa',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.cPp9d4v4fRt2jslo45_ZBQHaE8&pid=Api',\n",
       "    'datePublished': '2020-05-02T18:25:00.0000000Z',\n",
       "    'contentUrl': 'https://www.turismoviajar.com/wp-content/uploads/2019/09/paris-2020.jpg',\n",
       "    'hostPageUrl': 'https://www.turismoviajar.com/paris-2020-capital-de-francia-y-principal-ciudad-de-europa/',\n",
       "    'contentSize': '175573 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.turismoviajar.com/paris-2020-capital-de-francia-y-principal-ciudad-de-europa/',\n",
       "    'width': 900,\n",
       "    'height': 600,\n",
       "    'thumbnail': {'width': 474, 'height': 316}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=22467B2A514F249E7210A5AA77D7205740BD032C&FORM=IQFRBA',\n",
       "    'name': 'Razones para visitar Paris ¬°Destino incre√≠ble!',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.QVfGyRQdfMzvVs8rpXggHwHaE8&pid=Api',\n",
       "    'datePublished': '2018-06-18T07:50:00.0000000Z',\n",
       "    'contentUrl': 'https://www.eldigitaldecanarias.net/images/aaa-2018/June/16/Pedido_1159.jpg',\n",
       "    'hostPageUrl': 'https://www.eldigitaldecanarias.net/sociedad/34225-razones-para-visitar-paris-destino-increible',\n",
       "    'contentSize': '129298 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.eldigitaldecanarias.net/sociedad/34225-razones-para-visitar-paris-destino-increible',\n",
       "    'width': 1050,\n",
       "    'height': 700,\n",
       "    'thumbnail': {'width': 474, 'height': 316}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=8264F8727FC0064E8CEDF909EDE76B7069A44F92&FORM=IQFRBA',\n",
       "    'name': 'Albums 103+ Pictures Pictures Of Paris City Superb',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.keT3d0HRiVlSkWqnseUX1wHaJG&pid=Api',\n",
       "    'datePublished': '2024-01-24T21:41:00.0000000Z',\n",
       "    'contentUrl': 'https://i.pinimg.com/originals/f2/bf/e0/f2bfe0c508a6aa953923e33ce121de6b.jpg',\n",
       "    'hostPageUrl': 'https://finwise.edu.vn/pictures-o-1693656449555436/',\n",
       "    'contentSize': '259113 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://finwise.edu.vn/pictures-o-1693656449555436/',\n",
       "    'width': 1080,\n",
       "    'height': 1328,\n",
       "    'thumbnail': {'width': 474, 'height': 582}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=46B7FDFE4410A0E6339B707A2EF8622A9163CAA7&FORM=IQFRBA',\n",
       "    'name': 'La Capital De Francia',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.VPF11d7uevtY4yfNR2pqGwHaE7&pid=Api',\n",
       "    'datePublished': '2024-02-22T05:35:00.0000000Z',\n",
       "    'contentUrl': 'https://a6q5u4k9.rocketcdn.me/wp-content/uploads/2019/03/9779174434_87bf9d7cc1_b.jpg',\n",
       "    'hostPageUrl': 'https://ar.inspiredpencil.com/pictures-2023/la-capital-de-francia',\n",
       "    'contentSize': '1713512 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://ar.inspiredpencil.com/pictures-2023/la-capital-de-francia',\n",
       "    'width': 2048,\n",
       "    'height': 1365,\n",
       "    'thumbnail': {'width': 474, 'height': 315}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=392CC267C0B38B6C8522E58F49FF2F852F4D4033&FORM=IQFRBA',\n",
       "    'name': 'Paris is the capital city of France',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.mrl1v1N_JgkHolVWSRR41wHaE-&pid=Api',\n",
       "    'datePublished': '2020-06-19T13:03:00.0000000Z',\n",
       "    'contentUrl': 'http://cdn.thinglink.me/api/image/692922461087334401/1240/10/scaletowidth',\n",
       "    'hostPageUrl': 'http://www.thinglink.com/scene/692922461087334401',\n",
       "    'contentSize': '405917 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'http://www.thinglink.com/scene/692922461087334401',\n",
       "    'width': 1240,\n",
       "    'height': 834,\n",
       "    'thumbnail': {'width': 474, 'height': 318}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=5C40EFCB11CB7A049A95788EC008E11516F46854&FORM=IQFRBA',\n",
       "    'name': 'What Is The Capital City Of France? | Isolated Traveller',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.ZSUd00gTHnOuKAUvCeQrogHaEK&pid=Api',\n",
       "    'datePublished': '2021-07-02T22:29:00.0000000Z',\n",
       "    'contentUrl': 'https://isolatedtraveller.com/wp-content/uploads/2021/05/What-is-the-capital-city-of-France-1.jpg',\n",
       "    'hostPageUrl': 'https://isolatedtraveller.com/what-is-the-capital-city-of-france/',\n",
       "    'contentSize': '252016 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://isolatedtraveller.com/what-is-the-capital-city-of-france/',\n",
       "    'width': 1200,\n",
       "    'height': 675,\n",
       "    'thumbnail': {'width': 474, 'height': 266}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=354ADA8B6BC1B71DFFE2ECADF262135985D1F58A&FORM=IQFRBA',\n",
       "    'name': '5 curiosidades sobre Par√≠s - Datos interesantes y curiosidades sobre la ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.DUy9W71um0syk9mAbQilAgHaE7&pid=Api',\n",
       "    'datePublished': '2019-03-03T03:56:00.0000000Z',\n",
       "    'contentUrl': 'https://a.cdn-hotels.com/gdcs/production125/d1582/732c78f0-f585-11e8-a5a3-0242ac110006.jpg?impolicy=fcrop&w=1600&h=1066&q=medium',\n",
       "    'hostPageUrl': 'https://es.hoteles.com/go/francia/curiosidades-sobre-paris',\n",
       "    'contentSize': '160969 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://es.hoteles.com/go/francia/curiosidades-sobre-paris',\n",
       "    'width': 1600,\n",
       "    'height': 1066,\n",
       "    'thumbnail': {'width': 474, 'height': 315}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=E7375FF4C3F4D5669E7E63B08A2C42A152DBBA56&FORM=IQFRBA',\n",
       "    'name': 'Collection 90+ Pictures What Is The Capital City Of France? Stunning',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.PiasCFQqd_LZqgBAZ9302wHaGR&pid=Api',\n",
       "    'datePublished': '2024-11-02T07:27:00.0000000Z',\n",
       "    'contentUrl': 'https://amp.agoravox.fr/local/cache-vignettes/L628xH532/Capture_d_ecran_2017-04-25_a_11-04-07-a974a.png',\n",
       "    'hostPageUrl': 'https://galleryz.online/what-is-th-1693772983509768/',\n",
       "    'contentSize': '301476 B',\n",
       "    'encodingFormat': 'png',\n",
       "    'hostPageDisplayUrl': 'https://galleryz.online/what-is-th-1693772983509768/',\n",
       "    'width': 628,\n",
       "    'height': 532,\n",
       "    'thumbnail': {'width': 474, 'height': 401}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=1D862ABD1D79D503888D90D94BD5708E47F7615A&FORM=IQFRBA',\n",
       "    'name': 'Dziesiƒôƒá najwa≈ºniejszych miast we Francji: Ludno≈õƒá i dziedzictwo ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.MQl99v3nnKUuzlbXJHyIBQHaE7&pid=Api',\n",
       "    'datePublished': '2021-07-28T06:44:00.0000000Z',\n",
       "    'contentUrl': 'https://www.actualidadviajes.com/wp-content/uploads/2021/07/1280px-Paris_vue_densemble_tour_Eiffel.jpg',\n",
       "    'hostPageUrl': 'https://www.actualidadviajes.com/pl/dziesi%C4%99%C4%87-najwa%C5%BCniejszych-miast-francji/',\n",
       "    'contentSize': '409425 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.actualidadviajes.com/pl/dziesiƒôƒá-najwa≈ºniejszych-miast-francji/',\n",
       "    'width': 1280,\n",
       "    'height': 853,\n",
       "    'thumbnail': {'width': 474, 'height': 315}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=848C5B690DC4B192CAFEBF19279BFD060514D4AF&FORM=IQFRBA',\n",
       "    'name': 'Capital De Par√≠s Y La Ciudad M√°s Populosa De Francia Foto de archivo ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.7lnEzHaeHH3LT_3ds00JfAHaLu&pid=Api',\n",
       "    'datePublished': '2023-05-28T22:12:00.0000000Z',\n",
       "    'contentUrl': 'https://thumbs.dreamstime.com/z/capital-de-par%C3%ADs-y-la-ciudad-m%C3%A1s-populosa-francia-106548330.jpg',\n",
       "    'hostPageUrl': 'https://es.dreamstime.com/capital-de-par%C3%ADs-y-la-ciudad-m%C3%A1s-populosa-francia-image106548330',\n",
       "    'contentSize': '196923 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://es.dreamstime.com/capital-de-par√≠s-y-la-ciudad-m√°s-populosa-francia-image106548330',\n",
       "    'width': 1067,\n",
       "    'height': 1690,\n",
       "    'thumbnail': {'width': 474, 'height': 750}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=46B7FDFE4410A0E6339B0A2BFEB533BAB64934DC&FORM=IQFRBA',\n",
       "    'name': 'La Capital De Francia',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.-WTnU3BmLP4vxOBQteuBzgHaEp&pid=Api',\n",
       "    'datePublished': '2024-02-22T05:35:00.0000000Z',\n",
       "    'contentUrl': 'http://www.francia.net/wp-content/uploads/El-Panteon-Paris.bmp',\n",
       "    'hostPageUrl': 'https://ar.inspiredpencil.com/pictures-2023/la-capital-de-francia',\n",
       "    'contentSize': '471056 B',\n",
       "    'encodingFormat': 'bmp',\n",
       "    'hostPageDisplayUrl': 'https://ar.inspiredpencil.com/pictures-2023/la-capital-de-francia',\n",
       "    'width': 500,\n",
       "    'height': 314,\n",
       "    'thumbnail': {'width': 474, 'height': 297}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=DB78DF9A154C896D7B03223B4D18F08A657920B2&FORM=IQFRBA',\n",
       "    'name': 'Viaje a PAR√çS | FRANCIA üá´üá∑: Capital de FRANCIA | Gu√≠a: Qu√© ver y hacer ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.GMMWwWD2G23tXcYCp7D4JAHaEK&pid=Api',\n",
       "    'datePublished': '2021-08-31T04:57:00.0000000Z',\n",
       "    'contentUrl': 'https://i.ytimg.com/vi/qDtez8dljvQ/maxresdefault.jpg',\n",
       "    'hostPageUrl': 'https://www.youtube.com/watch?v=qDtez8dljvQ',\n",
       "    'contentSize': '149268 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.youtube.com/watch?v=qDtez8dljvQ',\n",
       "    'width': 1280,\n",
       "    'height': 720,\n",
       "    'thumbnail': {'width': 474, 'height': 266}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=41CE97F5D469D1E27548D82AF256A385BCE79162&FORM=IQFRBA',\n",
       "    'name': 'Eiffel Tower Tickets & Prices: How to Make the Most of Your Visit [and ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.yc0Mr8QxXTt0Id5oCFaMYgHaE6&pid=Api',\n",
       "    'datePublished': '2019-10-19T17:00:00.0000000Z',\n",
       "    'contentUrl': 'https://www.22places.com/wp-content/uploads/2019/02/eiffel-tower-paris.jpg',\n",
       "    'hostPageUrl': 'https://www.22places.com/paris-eiffel-tower-tickets/',\n",
       "    'contentSize': '133137 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://www.22places.com/paris-eiffel-tower-tickets/',\n",
       "    'width': 1050,\n",
       "    'height': 696,\n",
       "    'thumbnail': {'width': 474, 'height': 314}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=4DAFE2D7C0F9CE6D9112FF9F5D6EDC9365CB23B7&FORM=IQFRBA',\n",
       "    'name': 'Paris capital of france at sunset featuring paris, france, and city ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP._-wA_phCLV9mv5-lBhM8LgHaE7&pid=Api',\n",
       "    'datePublished': '2021-01-16T03:03:00.0000000Z',\n",
       "    'contentUrl': 'https://images.creativemarket.com/0.1.0/ps/476628/1360/905/m1/fpnw/wm1/oq1o8vc2nqdqkqwbi1jhuogg1mdgef55oomjukf3zvrnesmnyhp3xj8zxrojuzfy-.jpg?1431093199&s=955a68b7a10205aceb9a9eb58951f1df',\n",
       "    'hostPageUrl': 'https://creativemarket.com/photocreo/266151-Paris-capital-of-france-at-sunset-featuring-paris-france-and-city',\n",
       "    'contentSize': '362025 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://creativemarket.com/photocreo/266151-Paris-capital-of-france-at-sunset-featuring-paris-france-and-city',\n",
       "    'width': 1360,\n",
       "    'height': 905,\n",
       "    'thumbnail': {'width': 474, 'height': 315}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=C0AFDB2BC07A8D3AB0CF27AD5D63FC2EF74A63FE&FORM=IQFRBA',\n",
       "    'name': 'image de la capital de france paris¬ª Info ‚â° Voyage - Carte - Plan',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.t7RoB9s9eJpBWIr1n2i4tAHaH5&pid=Api',\n",
       "    'datePublished': '2022-02-23T09:45:00.0000000Z',\n",
       "    'contentUrl': 'https://image.shutterstock.com/z/stock-photo-paris-capital-of-france-172011668.jpg',\n",
       "    'hostPageUrl': 'https://evasion-online.com/search/image-de-la-capital-de-france-paris',\n",
       "    'contentSize': '1285669 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://evasion-online.com/search/image-de-la-capital-de-france-paris',\n",
       "    'width': 1500,\n",
       "    'height': 1600,\n",
       "    'thumbnail': {'width': 474, 'height': 505}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=7552A92AB2EE358B2631FC4B0D8535394203F2D6&FORM=IQFRBA',\n",
       "    'name': 'Paris : The Capital City Of France | Interesting Facts About Paris',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.6C8p6XvS5q1XeARx_e1w_AHaEo&pid=Api',\n",
       "    'datePublished': '2020-01-02T07:26:00.0000000Z',\n",
       "    'contentUrl': 'http://www.nationalpedia.com/wp-content/uploads/2017/04/capital-city-of-France.jpg',\n",
       "    'hostPageUrl': 'http://www.nationalpedia.com/paris-the-capital-city-of-france/',\n",
       "    'contentSize': '389408 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'http://www.nationalpedia.com/paris-the-capital-city-of-france/',\n",
       "    'width': 1920,\n",
       "    'height': 1200,\n",
       "    'thumbnail': {'width': 474, 'height': 296}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=686D59B48522EECDF1091D1F87EF779F15423537&FORM=IQFRBA',\n",
       "    'name': 'Free Images : light, architecture, night, city, paris, skyscraper ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.AFjMTvSK1bMFlSJtczK4WgHaJ4&pid=Api',\n",
       "    'datePublished': '2021-03-20T16:43:00.0000000Z',\n",
       "    'contentUrl': 'https://get.pxhere.com/photo/light-architecture-night-city-paris-skyscraper-urban-monument-cityscape-france-europe-evening-tower-symbol-landmark-capital-eiffel-french-european-famous-metropolis-743733.jpg',\n",
       "    'hostPageUrl': 'https://pxhere.com/en/photo/743733',\n",
       "    'contentSize': '1359095 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://pxhere.com/en/photo/743733',\n",
       "    'width': 2220,\n",
       "    'height': 2960,\n",
       "    'thumbnail': {'width': 474, 'height': 632}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=B033D3F2B090AC8A6D708B335F27BAE161E93240&FORM=IQFRBA',\n",
       "    'name': 'Archives des Capitale fran√ßaise - Arts et Voyages',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.Eo7MjfD02x6ERXRA-f4XEgHaFj&pid=Api',\n",
       "    'datePublished': '2020-04-01T04:16:00.0000000Z',\n",
       "    'contentUrl': 'http://image.slidesharecdn.com/paris-121112175850-phpapp02/95/paris-thecapitalof-france-1-638.jpg?cb=1352743405',\n",
       "    'hostPageUrl': 'http://e-sushi.fr/tag/capitale-francaise',\n",
       "    'contentSize': '44397 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'http://e-sushi.fr/tag/capitale-francaise',\n",
       "    'width': 638,\n",
       "    'height': 479,\n",
       "    'thumbnail': {'width': 474, 'height': 355}},\n",
       "   {'webSearchUrl': 'https://www.bing.com/images/search?q=capital+de+francia&id=359DFB70F8DA758DE15BB1AEB8763C445E1CA216&FORM=IQFRBA',\n",
       "    'name': 'Los 56 mejores lugares tur√≠sticos de Francia que tienes que visitar ...',\n",
       "    'thumbnailUrl': 'https://tse1.mm.bing.net/th?id=OIP.6got6AgOdlSSTee3vX95qgHaE8&pid=Api',\n",
       "    'datePublished': '2019-07-20T00:30:00.0000000Z',\n",
       "    'contentUrl': 'https://tipsparatuviaje.com/wp-content/uploads/2019/07/basilica-del-sagrado-corazon.jpg',\n",
       "    'hostPageUrl': 'https://tipsparatuviaje.com/lugares-turisticos-de-francia/',\n",
       "    'contentSize': '642687 B',\n",
       "    'encodingFormat': 'jpeg',\n",
       "    'hostPageDisplayUrl': 'https://tipsparatuviaje.com/lugares-turisticos-de-francia/',\n",
       "    'width': 1440,\n",
       "    'height': 960,\n",
       "    'thumbnail': {'width': 474, 'height': 316}}]},\n",
       " 'relatedSearches': {'id': 'https://api.bing.microsoft.com/api/v7/#RelatedSearches',\n",
       "  'value': [{'text': 'paris facts',\n",
       "    'displayText': 'paris facts',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=Paris+facts'},\n",
       "   {'text': 'paris map',\n",
       "    'displayText': 'paris map',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=Paris+map'},\n",
       "   {'text': 'paris history',\n",
       "    'displayText': 'paris history',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=Paris+history'},\n",
       "   {'text': 'paris population',\n",
       "    'displayText': 'paris population',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=Paris+population'},\n",
       "   {'text': 'paris city',\n",
       "    'displayText': 'paris city',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=Paris+city'},\n",
       "   {'text': 'qu√© significa paris',\n",
       "    'displayText': 'qu√© significa paris',\n",
       "    'webSearchUrl': 'https://www.bing.com/search?q=qu%C3%A9+significa+Paris'}]},\n",
       " 'rankingResponse': {'mainline': {'items': [{'answerType': 'WebPages',\n",
       "     'resultIndex': 0,\n",
       "     'value': {'id': 'https://api.bing.microsoft.com/api/v7/#WebPages.0'}},\n",
       "    {'answerType': 'Images',\n",
       "     'value': {'id': 'https://api.bing.microsoft.com/api/v7/#Images'}}]},\n",
       "  'sidebar': {'items': [{'answerType': 'Entities',\n",
       "     'resultIndex': 0,\n",
       "     'value': {'id': 'https://api.bing.microsoft.com/api/v7/#Entities.0'}},\n",
       "    {'answerType': 'RelatedSearches',\n",
       "     'value': {'id': 'https://api.bing.microsoft.com/api/v7/#RelatedSearches'}}]}}}"
      ]
     },
     "execution_count": 60,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "search_bing_for_data(\"Capital de Francia\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Registro de Tool para llamadas Azure Open AI"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 61,
   "metadata": {},
   "outputs": [],
   "source": [
    "tool_map = {\n",
    "      \"search_bing_for_data\": search_bing_for_data\n",
    "},\n",
    "tools = [\n",
    "     {\n",
    "            \"type\": \"function\",\n",
    "            \"function\": {\n",
    "                  \"name\": \"search_bing_for_data\",\n",
    "                  \"description\": \"Search for data on the internet for a given topic\",\n",
    "                  \"parameters\": {\n",
    "                        \"type\": \"object\",\n",
    "                        \"properties\": {\n",
    "                              \"query\": {\n",
    "                              \"type\": \"string\",\n",
    "                              \"description\": \"The content to search for\",\n",
    "                              \"required\": [\"query\"]\n",
    "                              }\n",
    "                        }\n",
    "                  }\n",
    "                  }\n",
    "            }\n",
    "      \n",
    "]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Llamada API con tool"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "metadata": {},
   "outputs": [],
   "source": [
    "from pyexpat.errors import messages\n",
    "\n",
    "\n",
    "    \n",
    "def call_azure_openai_with_tools(az_openai_client, az_openai_deployment_name, messages, tools, tool_choice=\"auto\"):\n",
    "    # Build the parameters dynamically\n",
    "    params = {\n",
    "        \"model\": az_openai_deployment_name,\n",
    "        \"messages\": messages,\n",
    "        \"tools\": tools,\n",
    "        \"tool_choice\": tool_choice\n",
    "    }\n",
    "    # Call the Azure OpenAI API\n",
    "    response = az_openai_client.chat.completions.create(**params)\n",
    "    return response.choices[0]\n",
    "\n",
    "def send_user_input_to_az_openai_with_tools(\n",
    "        user_input,\n",
    "        az_openai_client=az_openai_client,\n",
    "        az_openai_deployment_name=az_openai_deployment_name,\n",
    "        messages=messages,\n",
    "        tools=tools,\n",
    "        tool_choice=\"auto\"\n",
    "     \n",
    "):\n",
    "    \n",
    "       \n",
    "    \n",
    "    # Store user message\n",
    "    store_message_in_list(messages, \"user\", content=user_input)\n",
    "    # Query Azure OpenAI\n",
    "    az_openai_response = call_azure_openai_with_tools(az_openai_client, az_openai_deployment_name, messages, tools, tool_choice)\n",
    "    \n",
    "    az_openai_response\n",
    "    \n",
    "    return az_openai_response\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "La respuesta de un modelo indica  que hay que ejecutar una Tool"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "post_cutoff_question = \"quien gano la- EURO 2024?'\"\n",
    "\n",
    "model_response = send_user_input_to_az_openai_with_tools(post_cutoff_question)\n",
    "print(model_response)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "base",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
